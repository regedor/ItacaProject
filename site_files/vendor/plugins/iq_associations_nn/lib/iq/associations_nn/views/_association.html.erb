<% r2 = @registry[:CLASS][:Resource2].first({:conditions => { :id => association.send(@registry[:resource2_id])}}) %>

<% #if association.send @registry[:resource2]
  prefix = association.new_record? ? 'new' : 'existing'
  fieldname = "#{@registry[:resource1]}[#{prefix}_#{@registry[:associations]}_attributes][]" %>

  <div class="<%= @registry[:association] %>">
    <% if prefix == 'existing' %>
      <% fields_for fieldname, association do |r2_form| %>
      
        <%= r2_form.hidden_field @registry[:resource2_id] %>
	
        <%= r2.send @registry[:show_field] %> 
        <%= r2_form.check_box :association_should_exist  %>
      
      <% end %> 
    <% else %>
      <%fieldname = "#{@registry[:resource1]}[#{prefix}_#{@registry[:associations]}_attributes][#{association.send @registry[:resource2_id]}]" %>
    
        <%= hidden_field_tag (fieldname + "[#{@registry[:resource2_id]}]"), (association.send @registry[:resource2_id]) %>
      
        <%= r2.send @registry[:show_field] %> 
        <%  text_field_tag fieldname + 'association_should_exist' %>
      
        <%= check_box_tag fieldname + "[association_should_exist]", "1", association.association_should_exist=="1" %>
      
    <% end %>
  </div>
  
  <% #end 
%>

